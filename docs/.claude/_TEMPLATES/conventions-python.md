# Python Project Conventions

## Code Style

### PEP 8 Compliance (Enforced by Ruff)
- **Line Length:** Max 88 characters (configurable in ruff)
- **Indentation:** 4 spaces (never tabs)
- **Blank Lines:** 2 between top-level definitions, 1 between methods
- **Imports:** One per line, grouped and sorted automatically by ruff

### Naming Conventions
| Type | Convention | Example |
|------|------------|---------|
| Variables | snake_case | `user_name`, `is_active` |
| Constants | UPPER_SNAKE_CASE | `MAX_RETRY_COUNT` |
| Functions | snake_case | `get_user_by_id()` |
| Classes | PascalCase | `UserService` |
| Private | Leading underscore | `_internal_method()` |
| Protected | Leading underscore | `_protected_var` |
| Magic/Dunder | Double underscore | `__init__`, `__str__` |
| Modules | snake_case | `user_service.py` |
| Packages | snake_case, no hyphens | `auth_module` |

### Type Hints (Python 3.9+)
```python
from typing import Optional, List, Dict, Union, Literal

def process_user(
    user_id: int,
    name: str,
    tags: Optional[List[str]] = None,
    metadata: Dict[str, Union[str, int]] = {}
) -> Dict[str, Any]:
    """Process user data with proper type hints."""
    pass
```

### File Organization (uv Project Structure)
```
project/
├── src/
│   ├── project_name/      # Main package directory
│   │   ├── __init__.py
│   │   ├── models/
│   │   │   ├── __init__.py
│   │   │   ├── user.py
│   │   │   └── base.py
│   │   ├── services/
│   │   │   ├── __init__.py
│   │   │   └── user_service.py
│   │   ├── utils/
│   │   │   ├── __init__.py
│   │   │   └── helpers.py
│   │   └── config/
│   │       ├── __init__.py
│   │       └── settings.py
├── tests/
│   ├── unit/
│   ├── integration/
│   └── conftest.py
├── .env.example
├── pyproject.toml         # Project configuration (uv, ruff, etc.)
├── uv.lock               # Lock file generated by uv
├── .python-version       # Python version for the project
└── README.md
```

### Import Order (Ruff manages this automatically)
```python
# Standard library imports
import os
import sys
from datetime import datetime
from typing import Optional

# Third-party imports
import pandas as pd
import numpy as np
from fastapi import FastAPI
from sqlalchemy import create_engine

# Local application imports
from .models import User
from .services import UserService
from .utils.helpers import format_date

# Note: Ruff's isort rules will automatically organize imports
# Configure in pyproject.toml under [tool.ruff.lint.isort]
```

## Docstring Standards (Google Style)

### Function/Method Docstrings
```python
def calculate_discount(
    price: float,
    discount_percentage: float,
    max_discount: Optional[float] = None
) -> float:
    """Calculate the discounted price for an item.

    Args:
        price: Original price in dollars.
        discount_percentage: Discount as a percentage (0-100).
        max_discount: Maximum discount amount allowed.

    Returns:
        The final price after applying the discount.

    Raises:
        ValueError: If price is negative or discount is invalid.

    Examples:
        >>> calculate_discount(100.0, 20.0)
        80.0
        >>> calculate_discount(100.0, 20.0, max_discount=15.0)
        85.0
    """
    pass
```

### Class Docstrings
```python
class UserService:
    """Service for managing user operations.

    This service handles all user-related business logic including
    creation, authentication, and profile management.

    Attributes:
        db: Database connection instance.
        cache: Redis cache client.
        logger: Logger instance for this service.

    Example:
        >>> service = UserService(db_connection)
        >>> user = service.create_user("john@example.com")
    """
```

## Error Handling

### Custom Exceptions
```python
class AppError(Exception):
    """Base exception for application errors."""
    pass

class ValidationError(AppError):
    """Raised when validation fails."""
    def __init__(self, field: str, message: str):
        self.field = field
        self.message = message
        super().__init__(f"{field}: {message}")

class NotFoundError(AppError):
    """Raised when a resource is not found."""
    pass
```

### Exception Handling Pattern
```python
from typing import Optional
import logging

logger = logging.getLogger(__name__)

def safe_operation() -> Optional[Result]:
    """Perform operation with proper error handling."""
    try:
        result = risky_operation()
        return result
    except ValidationError as e:
        logger.warning(f"Validation failed: {e}")
        raise  # Re-raise for API layer to handle
    except Exception as e:
        logger.exception("Unexpected error occurred")
        raise AppError("Internal error occurred") from e
    finally:
        cleanup_resources()
```

## Testing Conventions

### Test Structure (pytest)
```python
import pytest
from unittest.mock import Mock, patch

class TestUserService:
    """Test cases for UserService."""

    @pytest.fixture
    def service(self):
        """Create service instance for testing."""
        return UserService(db=Mock())

    def test_create_user_success(self, service):
        """Test successful user creation."""
        # Arrange
        email = "test@example.com"

        # Act
        user = service.create_user(email)

        # Assert
        assert user.email == email
        assert user.id is not None

    def test_create_user_duplicate_email(self, service):
        """Test user creation with duplicate email."""
        with pytest.raises(ValidationError) as exc_info:
            service.create_user("existing@example.com")

        assert exc_info.value.field == "email"
```

### Test File Naming
- Unit tests: `test_[module_name].py`
- Integration tests: `test_integration_[feature].py`
- End-to-end: `test_e2e_[scenario].py`

## Async/Await Patterns

### Async Function Standards
```python
import asyncio
from typing import List

async def fetch_user_data(user_ids: List[int]) -> List[User]:
    """Fetch multiple users concurrently.

    Args:
        user_ids: List of user IDs to fetch.

    Returns:
        List of User objects.
    """
    tasks = [fetch_user(uid) for uid in user_ids]
    users = await asyncio.gather(*tasks, return_exceptions=True)

    # Filter out exceptions
    return [u for u in users if not isinstance(u, Exception)]

async def fetch_user(user_id: int) -> User:
    """Fetch single user asynchronously."""
    async with aiohttp.ClientSession() as session:
        async with session.get(f"/api/users/{user_id}") as response:
            data = await response.json()
            return User(**data)
```

## Configuration Management

### Settings Pattern (Pydantic)
```python
from pydantic import BaseSettings, validator
from typing import Optional

class Settings(BaseSettings):
    """Application settings with validation."""

    # Database
    database_url: str
    database_pool_size: int = 10

    # API
    api_key: str
    api_version: str = "v1"

    # Features
    debug_mode: bool = False
    max_upload_size: int = 10_000_000  # 10MB

    @validator("database_url")
    def validate_db_url(cls, v):
        if not v.startswith(("postgresql://", "mysql://")):
            raise ValueError("Invalid database URL")
        return v

    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"
        case_sensitive = False

# Singleton pattern for settings
settings = Settings()
```

## Logging Standards

### Logger Setup
```python
import logging
import sys
from logging.handlers import RotatingFileHandler

def setup_logging(level=logging.INFO):
    """Configure application logging."""
    log_format = (
        "%(asctime)s - %(name)s - %(levelname)s - "
        "%(filename)s:%(lineno)d - %(message)s"
    )

    # Console handler
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(logging.Formatter(log_format))

    # File handler with rotation
    file_handler = RotatingFileHandler(
        "app.log",
        maxBytes=10_000_000,  # 10MB
        backupCount=5
    )
    file_handler.setFormatter(logging.Formatter(log_format))

    # Root logger configuration
    root_logger = logging.getLogger()
    root_logger.setLevel(level)
    root_logger.addHandler(console_handler)
    root_logger.addHandler(file_handler)

    # Silence noisy libraries
    logging.getLogger("urllib3").setLevel(logging.WARNING)
```

### Logger Usage
```python
import logging

logger = logging.getLogger(__name__)

class UserService:
    def create_user(self, email: str) -> User:
        logger.info(f"Creating user with email: {email}")
        try:
            user = User(email=email)
            logger.debug(f"User object created: {user.id}")
            return user
        except Exception as e:
            logger.exception(f"Failed to create user: {email}")
            raise
```

## Database Patterns

### SQLAlchemy Models
```python
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from datetime import datetime

Base = declarative_base()

class User(Base):
    """User model with SQLAlchemy ORM."""
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    email = Column(String(255), unique=True, nullable=False, index=True)
    username = Column(String(50), unique=True, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # Relationships
    posts = relationship("Post", back_populates="author")

    def __repr__(self):
        return f"<User(id={self.id}, email='{self.email}')>"
```

## Performance Guidelines

### Profiling Decorators
```python
import time
import functools
import logging

logger = logging.getLogger(__name__)

def timeit(func):
    """Decorator to measure function execution time."""
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        start = time.perf_counter()
        result = func(*args, **kwargs)
        end = time.perf_counter()
        logger.debug(f"{func.__name__} took {end - start:.4f} seconds")
        return result
    return wrapper

def memoize(func):
    """Cache function results."""
    cache = {}

    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        key = (args, tuple(kwargs.items()))
        if key not in cache:
            cache[key] = func(*args, **kwargs)
        return cache[key]
    return wrapper
```

## Security Best Practices

### Input Validation
```python
from typing import Optional
import re
import hashlib
import secrets

def validate_email(email: str) -> bool:
    """Validate email format."""
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return bool(re.match(pattern, email))

def hash_password(password: str) -> str:
    """Hash password with salt using pbkdf2."""
    salt = secrets.token_hex(32)
    pwdhash = hashlib.pbkdf2_hmac(
        'sha256',
        password.encode('utf-8'),
        salt.encode('utf-8'),
        100_000  # iterations
    )
    return f"{salt}${pwdhash.hex()}"

def sanitize_input(text: str) -> str:
    """Remove potentially dangerous characters."""
    # Remove null bytes
    text = text.replace('\x00', '')
    # Escape HTML
    text = text.replace('<', '&lt;').replace('>', '&gt;')
    return text.strip()
```

## Package Management with uv

### Project Initialization
```bash
# Create new project
uv init project-name

# Initialize in existing directory
uv init

# Create library project
uv init --lib

# Create application project
uv init --app
```

### Dependency Management
```bash
# Add dependencies
uv add fastapi pydantic

# Add development dependencies
uv add --dev pytest ruff mypy

# Add optional dependency group
uv add --optional docs sphinx

# Install all dependencies
uv sync

# Install with extras
uv sync --extra dev --extra docs
```

## Modern Python Tooling

### pyproject.toml Configuration
```toml
[project]
name = "example-project"
version = "0.1.0"
description = "Your project description"
readme = "README.md"
requires-python = ">=3.11"
dependencies = [
    "fastapi>=0.100.0",
    "pydantic>=2.0",
    "sqlalchemy>=2.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=7.4",
    "pytest-cov>=4.1",
    "pytest-asyncio>=0.21",
    "mypy>=1.5",
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

# uv Configuration
[tool.uv]
dev-dependencies = [
    "ruff>=0.5.0",
    "mypy>=1.10.0",
    "pytest>=8.0.0",
    "pytest-cov>=5.0.0",
]

# Ruff Configuration (Linter + Formatter)
[tool.ruff]
# Exclude common directories
exclude = [
    ".git",
    ".venv",
    "__pycache__",
    ".mypy_cache",
    ".pytest_cache",
    ".ruff_cache",
    "build",
    "dist",
]

# Same as Black
line-length = 88
indent-width = 4

# Target Python 3.11+
target-version = "py311"

# Enable preview features
preview = true

[tool.ruff.lint]
# Enable comprehensive rule sets
select = [
    "E",    # pycodestyle errors
    "W",    # pycodestyle warnings
    "F",    # Pyflakes
    "B",    # flake8-bugbear
    "I",    # isort
    "N",    # pep8-naming
    "UP",   # pyupgrade
    "SIM",  # flake8-simplify
    "S",    # flake8-bandit (security)
    "C90",  # mccabe complexity
    "RUF",  # Ruff-specific rules
    "ASYNC",# flake8-async
    "ARG",  # flake8-unused-arguments
    "PTH",  # flake8-use-pathlib
    "PL",   # Pylint
]

# Ignore specific rules
ignore = [
    "E501",   # Line too long (handled by formatter)
    "S101",   # Use of assert (needed for tests)
    "PLR0913", # Too many arguments
]

# Allow autofix for all enabled rules
fixable = ["ALL"]
unfixable = []

# Allow unused variables when underscore-prefixed
dummy-variable-rgx = "^(_+|(_+[a-zA-Z0-9_]*[a-zA-Z0-9]+?))$"

# Configure specific linters
[tool.ruff.lint.pycodestyle]
max-doc-length = 88

[tool.ruff.lint.isort]
known-first-party = ["your_package_name"]
force-single-line = false
lines-after-imports = 2

[tool.ruff.lint.pydocstyle]
convention = "google"

[tool.ruff.lint.mccabe]
max-complexity = 10

[tool.ruff.lint.pylint]
max-args = 6
max-returns = 3

[tool.ruff.lint.per-file-ignores]
"__init__.py" = ["F401", "E402"]
"tests/**/*.py" = ["S101", "PLR2004"]
"migrations/**/*.py" = ["E501"]

[tool.ruff.format]
# Use double quotes for strings
quote-style = "double"

# Indent with spaces
indent-style = "space"

# Respect magic trailing commas
skip-magic-trailing-comma = false

# Unix-style line endings
line-ending = "lf"

# Format code in docstrings
docstring-code-format = true

# Format code in docstrings with dynamic line length
docstring-code-line-length = "dynamic"

# Pytest Configuration
[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py", "*_test.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = [
    "-ra",
    "--strict-markers",
    "--cov=src",
    "--cov-report=term-missing",
    "--cov-report=html",
    "--cov-report=xml",
]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "integration: marks tests as integration tests",
    "unit: marks tests as unit tests",
]

# Mypy Configuration
[tool.mypy]
python_version = "3.11"
strict = true
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
disallow_any_generics = true
check_untyped_defs = true
no_implicit_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
follow_imports = "normal"
ignore_missing_imports = true
pretty = true
show_column_numbers = true
show_error_codes = true
show_error_context = true

# Coverage Configuration
[tool.coverage.run]
source = ["src"]
branch = true
parallel = true
omit = [
    "*/tests/*",
    "*/test_*.py",
    "*/__init__.py",
]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "if self.debug:",
    "if __name__ == .__main__.:",
    "raise NotImplementedError",
    "if TYPE_CHECKING:",
    "class .*\\bProtocol\\):",
    "@(abc\\.)?abstractmethod",
]
precision = 2
show_missing = true
```

## Development Workflow Commands

### Using uv for Development
```bash
# Create virtual environment and install dependencies
uv sync

# Run Python scripts
uv run python main.py

# Run with specific Python version
uv run --python 3.12 python main.py

# Add new dependency
uv add requests

# Add dev dependency
uv add --dev pytest-mock

# Update dependencies
uv lock --upgrade

# Show installed packages
uv pip list

# Run tests
uv run pytest

# Run specific test file
uv run pytest tests/test_user.py

# Run with coverage
uv run pytest --cov
```

### Using Ruff for Code Quality
```bash
# Check code with Ruff linter
ruff check .

# Fix auto-fixable issues
ruff check --fix .

# Format code with Ruff formatter
ruff format .

# Check formatting without changing files
ruff format --check .

# Run both linter and formatter
ruff check --fix . && ruff format .

# Watch files and auto-fix
ruff check --watch --fix .

# Show detailed explanations for rules
ruff rule E501
```

### Type Checking with Mypy
```bash
# Run mypy on source code
uv run mypy src/

# Run with specific configuration
uv run mypy --config-file pyproject.toml src/

# Ignore missing imports
uv run mypy --ignore-missing-imports src/
```

## VS Code Configuration

### .vscode/settings.json
```json
{
  "python.linting.enabled": false,
  "python.formatting.provider": "none",
  "[python]": {
    "editor.defaultFormatter": "charliermarsh.ruff",
    "editor.formatOnSave": true,
    "editor.codeActionsOnSave": {
      "source.organizeImports": "explicit",
      "source.fixAll.ruff": "explicit"
    }
  },
  "ruff.lint.enable": true,
  "ruff.format.enable": true,
  "ruff.organizeImports": true,
  "python.testing.pytestEnabled": true,
  "python.testing.pytestArgs": [
    "tests"
  ]
}
```

### .vscode/extensions.json
```json
{
  "recommendations": [
    "charliermarsh.ruff",
    "ms-python.python",
    "ms-python.vscode-pylance",
    "ms-python.mypy-type-checker"
  ]
}
```

## Pre-commit Configuration

### .pre-commit-config.yaml
```yaml
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.5.0
    hooks:
      # Run the linter
      - id: ruff
        args: [--fix]
      # Run the formatter
      - id: ruff-format

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.10.0
    hooks:
      - id: mypy
        additional_dependencies: [types-requests]

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
      - id: check-merge-conflict
      - id: detect-private-key
```

---
*Last Updated: [Date]*
*Python Version: 3.11+*
*Tools: uv (package management), ruff (linting & formatting), mypy (type checking)*